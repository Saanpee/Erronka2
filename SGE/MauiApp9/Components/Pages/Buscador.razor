@page "/buscador"
@using MauiApp9.Models
@using System.Text.Json
@inject IJSRuntime JS
@inject NavigationManager Nav

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-primary fw-bold">Euskadiko Zentroen Kudeaketa</h1>
        <div class="d-flex gap-2">
            @if (!mostrandoFormulario)
            {
                <button class="btn btn-outline-danger shadow-sm" @onclick="RestaurarOriginalAsync">
                    <i class="bi bi-arrow-counterclockwise"></i> BERRESKURATU JSONa
                </button>
                <button class="btn btn-success shadow-sm" @onclick="PrepararNuevo">
                    <i class="bi bi-plus-circle"></i> ZENTRO BERRIA GEHITU
                </button>
            }
        </div>
    </div>

    @if (mostrandoFormulario)
    {
        <div class="card p-4 mb-4 border-primary shadow bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="text-dark m-0">
                    <i class="bi bi-pencil-square me-2"></i>
                    @(centroTmp.Codigo == 0 ? "ZENTRO BERRIA GEHITU" : "ZENTROA ALDATU")
                </h3>
                <button class="btn btn-outline-secondary btn-sm" @onclick="() => mostrandoFormulario = false">
                    <i class="bi bi-arrow-left"></i> BUELTATU
                </button>
            </div>
            <hr />
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Zentroaren Izena</label>
                    <input class="form-control" @bind="centroTmp.Nombre" placeholder="Izena idatzi..." />
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Udalerria</label>
                    <input class="form-control" @bind="centroTmp.Municipio" placeholder="Herria..." />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Lurraldea</label>
                    <select class="form-select" @bind="centroTmp.Territorio">
                        <option value="">Aukeratu...</option>
                        @foreach (var t in listaTerritoriosForm)
                        {
                            <option value="@t">@t</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Zentro Mota</label>
                    <select class="form-select" @bind="centroTmp.TipoCentro">
                        <option value="">Aukeratu...</option>
                        @foreach (var tipo in listaTiposForm)
                        {
                            <option value="@tipo">@tipo</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Latitud</label>
                    <input type="number" step="any" class="form-control" @bind="centroTmp.Latitud" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Longitud</label>
                    <input type="number" step="any" class="form-control" @bind="centroTmp.Longitud" />
                </div>
            </div>
            <div class="mt-4 d-flex gap-2 justify-content-end">
                <button class="btn btn-secondary px-4 shadow-sm" @onclick="() => mostrandoFormulario = false">UTZI</button>
                <button class="btn btn-primary px-4 shadow-sm fw-bold" @onclick="GuardarCentroAsync">GORDE</button>
            </div>
        </div>
    }

    <div class="card p-3 mb-4 shadow-sm border-secondary bg-white">
        <h5 class="mb-3 text-secondary fw-bold">BILATZAILEA</h5>
        <div class="row g-3">
            <div class="col-md-4">
                <label class="fw-bold small text-uppercase">Mota:</label>
                <select class="form-select mt-1" @onchange="OnTipoChange">
                    <option value="">Guztiak</option>
                    @foreach (var t in listaTiposFiltro)
                    {
                        <option value="@t">@t</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small text-uppercase">Lurraldea:</label>
                <select class="form-select mt-1" @onchange="OnTerritorioChange" disabled="@(string.IsNullOrEmpty(tipoSel))">
                    <option value="">Guztiak</option>
                    @foreach (var t in listaTerritoriosFiltro)
                    {
                        <option value="@t">@t</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label class="fw-bold small text-uppercase">Udalerria:</label>
                <select class="form-select mt-1" @onchange="OnMunicipioChange" disabled="@(string.IsNullOrEmpty(territorioSel))">
                    <option value="">Guztiak</option>
                    @foreach (var m in listaMunicipiosFiltro)
                    {
                        <option value="@m">@m</option>
                    }
                </select>
            </div>
        </div>
    </div>

    @if (centrosFiltrados != null)
    {
        <div class="alert alert-info py-2 shadow-sm mb-3 d-flex justify-content-between align-items-center">
            <span>Guztira: <strong>@centrosFiltrados.Count</strong> zentro aurkitu dira.</span>
        </div>

        <div class="table-responsive shadow-sm rounded">
            <table class="table table-striped table-hover border mb-0 bg-white">
                <thead class="table-dark">
                    <tr>
                        <th>IZENA</th>
                        <th>UDALERRIA</th>
                        <th class="text-center">EKINTZAK</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in centrosFiltrados)
                    {
                        <tr>
                            <td class="align-middle">@c.Nombre</td>
                            <td class="align-middle">@c.Municipio</td>
                            <td class="text-center">
                                <div class="btn-group shadow-sm">
                                    <button class="btn btn-sm btn-info text-white" @onclick='() => Nav.NavigateTo($"/detalle/{c.Codigo}")'>IKUSI</button>
                                    <button class="btn btn-sm btn-warning mx-1" @onclick="() => PrepararEdicion(c)">ALDATU</button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => EliminarAsync(c.Codigo)">EZABATU</button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Centro> todosLosCentros = new();
    private List<Centro> centrosFiltrados = new();
    private Centro centroTmp = new Centro();
    private bool mostrandoFormulario = false;

    private string tipoSel, territorioSel, municipioSel;
    private List<string> listaTiposFiltro = new(), listaTerritoriosFiltro = new(), listaMunicipiosFiltro = new();
    private List<string> listaTerritoriosForm = new(), listaTiposForm = new();

    private const string CentrosFileName = "EuskadiLatLonUser.json";

    protected override async Task OnInitializedAsync()
    {
        todosLosCentros = await CargarCentrosAsync();

        foreach (var c in todosLosCentros)
        {
            if (Math.Abs(c.Latitud) < Math.Abs(c.Longitud))
            {
                double temp = c.Latitud; c.Latitud = c.Longitud; c.Longitud = temp;
            }
        }

        listaTerritoriosForm = todosLosCentros.Select(c => c.Territorio).Distinct().OrderBy(x => x).ToList();
        listaTiposForm = todosLosCentros.Select(c => c.TipoCentro).Distinct().OrderBy(x => x).ToList();

        ActualizarListasFiltros();
    }

    private async Task<List<Centro>> CargarCentrosAsync()
    {
        var file = Path.Combine(FileSystem.AppDataDirectory, CentrosFileName);

        if (File.Exists(file))
        {
            var json = await File.ReadAllTextAsync(file);
            var root = JsonSerializer.Deserialize<RootObject>(json);
            return root?.Centros ?? new List<Centro>();
        }
        else
        {
            using var stream = await FileSystem.OpenAppPackageFileAsync("EuskadiLatLon.json");
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();
            var root = JsonSerializer.Deserialize<RootObject>(json);
            return root?.Centros ?? new List<Centro>();
        }
    }

    private async Task GuardarCentrosAsync()
    {
        var root = new RootObject { Centros = todosLosCentros };
        var json = JsonSerializer.Serialize(root);
        var file = Path.Combine(FileSystem.AppDataDirectory, CentrosFileName);
        await File.WriteAllTextAsync(file, json);
    }

    private async Task RestaurarOriginalAsync()
    {
        bool confirmar = await JS.InvokeAsync<bool>("confirm", "Ziur zaude? Honek aldaketa guztiak ezabatuko ditu.");
        if (confirmar)
        {
            var file = Path.Combine(FileSystem.AppDataDirectory, CentrosFileName);
            if (File.Exists(file)) File.Delete(file);
            tipoSel = territorioSel = municipioSel = null;
            await OnInitializedAsync();
            StateHasChanged();
        }
    }

    private void OnTipoChange(ChangeEventArgs e)
    {
        tipoSel = e.Value?.ToString(); territorioSel = null; municipioSel = null;
        listaTerritoriosFiltro = todosLosCentros.Where(c => c.TipoCentro == tipoSel).Select(c => c.Territorio).Distinct().OrderBy(x => x).ToList();
        Filtrar();
    }

    private void OnTerritorioChange(ChangeEventArgs e)
    {
        territorioSel = e.Value?.ToString(); municipioSel = null;
        listaMunicipiosFiltro = todosLosCentros.Where(c => c.TipoCentro == tipoSel && c.Territorio == territorioSel).Select(c => c.Municipio).Distinct().OrderBy(x => x).ToList();
        Filtrar();
    }

    private void OnMunicipioChange(ChangeEventArgs e)
    {
        municipioSel = e.Value?.ToString();
        Filtrar();
    }

    private void Filtrar()
    {
        centrosFiltrados = todosLosCentros.Where(c =>
            (string.IsNullOrEmpty(tipoSel) || c.TipoCentro == tipoSel) &&
            (string.IsNullOrEmpty(territorioSel) || c.Territorio == territorioSel) &&
            (string.IsNullOrEmpty(municipioSel) || c.Municipio == municipioSel)
        ).OrderBy(c => c.Nombre).ToList();
    }

    private void ActualizarListasFiltros()
    {
        listaTiposFiltro = todosLosCentros.Select(c => c.TipoCentro).Distinct().OrderBy(x => x).ToList();
        Filtrar();
    }

    private void PrepararNuevo() { centroTmp = new Centro(); mostrandoFormulario = true; }

    private void PrepararEdicion(Centro c)
    {
        centroTmp = new Centro
            {
                Codigo = c.Codigo,
                Nombre = c.Nombre,
                Municipio = c.Municipio,
                TipoCentro = c.TipoCentro,
                Territorio = c.Territorio,
                Latitud = c.Latitud,
                Longitud = c.Longitud
            };
        mostrandoFormulario = true;
    }

    private async Task GuardarCentroAsync()
    {
        if (string.IsNullOrEmpty(centroTmp.Nombre)) return;

        if (centroTmp.Codigo == 0)
        {
            centroTmp.Codigo = todosLosCentros.Any() ? todosLosCentros.Max(c => c.Codigo) + 1 : 1;
            todosLosCentros.Add(centroTmp);
        }
        else
        {
            var idx = todosLosCentros.FindIndex(c => c.Codigo == centroTmp.Codigo);
            if (idx != -1) todosLosCentros[idx] = centroTmp;
        }

        mostrandoFormulario = false;
        ActualizarListasFiltros();
        await GuardarCentrosAsync();
    }

    private async Task EliminarAsync(int id)
    {
        if (await JS.InvokeAsync<bool>("confirm", "Ziur zaude ezabatu nahi duzula?"))
        {
            todosLosCentros.RemoveAll(c => c.Codigo == id);
            ActualizarListasFiltros();
            await GuardarCentrosAsync();
        }
    }
}